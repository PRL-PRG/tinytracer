---
title: "Composition report"
author: "K. Siek"
date: "October 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(lemon)
#library(ascii)

options(dplyr.print_max = 1e9)
knit_print.data.frame <- lemon_print

print_ascii <- T
pretty_print_data <- function(data)
  if (print_ascii) {
    #ascii(data, header=F, include.rownames=F)
    print.data.frame(data, row.names=F)
  } else{ 
    lemon_print(data, options=c())
  }

get_data <- function(path) {
  all_files <- list.files(path=path, recursive=TRUE, full.names = TRUE)  
  all_files <- all_files[grepl(".*.csv$", all_files)]
  data <- lapply(all_files, function(path) {
    write(paste0("reading ", path), stderr())
    tryCatch(cbind(input=path, read.csv(path)), error=function(e) NULL)
  })
  data[!sapply(data, is.null)]
}
  
concatenate_data <- function(data) do.call(rbind, data)

cut_decimals <- function(x, decimal_points=2) floor(x * (10^decimal_points)) / (10^decimal_points)

format_large_ints <- function(x)
  ifelse(is.na(x), 
         "NA", 
         ifelse(x < (10^3), 
                paste0(cut_decimals(x)), 
                ifelse(x < (10^6), 
                       paste0(cut_decimals(x/(10^3)), "K"), 
                       ifelse(x < (10^9), 
                              paste0(cut_decimals(x/(10^6)), "M"),
                              paste0(cut_decimals(x/(10^9)), "B")))))

format_percents <- function(x) 
  ifelse(x == 0, "0", 
         ifelse(x < 0.01, "<1%",
                paste0(cut_decimals(x), "%")))

format_align <- function(x) paste0(strrep(" ", max(nchar(x)) - nchar(x)), x)

format_log_buckets <- function(n) 
  ifelse(n==0 | n==1, 
         as.character(n), 
         paste0(format_large_ints(2^(n-1)), "-", format_large_ints(2^n - 1)))

filter_and_format_triples <- function(data, type)
    data %>% 
    filter(type == !!type) %>% 
    select(-type) %>%
    arrange(desc(count)) %>%
    mutate(percent=format_percents(100*count/sum(count, na.rm=T))) %>%
    mutate(count=format_large_ints(count)) %>%
    filter(percent != "<1%")

filter_and_format_vectors <- function(data, type) 
    data %>% 
    filter(type == !!type) %>% 
    arrange(desc(count)) %>%
    mutate(length=format_log_buckets(as.numeric(car_type)), 
           true_length=format_log_buckets(as.numeric(tag_type))) %>%
    mutate(percent=format_percents(100*count/sum(count, na.rm=T))) %>%
    mutate(count=format_large_ints(count)) %>%
    filter(percent != "<1%") %>%
    select(type, length, true_length, count, percent) %>%
    select(-type) 

```

```{r read-data, comment="", echo=F}
data <- get_data("/tmp/vignettes/_results/18-10-11_17-06/composition/")
data <- concatenate_data(data)
data <- data %>%
  mutate(count=as.numeric(count)) %>%
  group_by(type, car_type, tag_type, cdr_type) %>% 
  summarize(count=sum(count)) %>%
  ungroup() %>%
  mutate(type=as.character(type), 
         car_type=as.character(car_type), 
         tag_type=as.character(tag_type), 
         cdr_type=as.character(cdr_type))
```

# Summary of types

```{r show-all, comment="", echo=F}
data %>% 
  group_by(type) %>% 
  summarize(count=sum(count, na.rm=T)) %>% 
  arrange(desc(count)) %>%
  ungroup() %>% 
  mutate(percent=format_percents(100*count/sum(count, na.rm=T))) %>%
  mutate(count=format_large_ints(count)) %>%
  pretty_print_data
```

# Lists

```{r show-listsxp, comment="", echo=F}
filter_and_format_triples(data, "LISTSXP") %>%
  rename(car=car_type, cdr=cdr_type, tag=tag_type) %>%
  pretty_print_data
```

# Promises

```{r show-promsxp, comment="", echo=F}
filter_and_format_triples(data, "PROMSXP") %>%
  rename(value=car_type, expr=cdr_type, env=tag_type) %>%
  pretty_print_data
```

# Environments

```{r show-envsxp, comment="", echo=F}
filter_and_format_triples(data, "ENVSXP") %>%
  rename(frame=car_type, enclos=cdr_type, hashtab=tag_type) %>%
  pretty_print_data
```

# Integer vectors

```{r show-intsxp, comment="", echo=F}
filter_and_format_vectors(data, "INTSXP") %>%
  pretty_print_data
```

# Logical vectors

```{r show-lglsxp, comment="", echo=F}
filter_and_format_vectors(data, "LGLSXP") %>%
  pretty_print_data
```

# Generic vectors

```{r show-vecsxp, comment="", echo=F}
filter_and_format_vectors(data, "VECSXP") %>%
  pretty_print_data
```

# Language lists

```{r show-langsxp, comment="", echo=F}
filter_and_format_triples(data, "LANGSXP") %>%
  pretty_print_data
```

# Dot-dot-dot

```{r show-dotsxp, comment="", echo=F}
filter_and_format_triples(data, "DOTSXP") %>%
  pretty_print_data
```

# Raw vectors

```{r show-rawsxp, comment="", echo=F}
filter_and_format_vectors(data, "RAWSXP") %>%
  pretty_print_data
```

# Closures

```{r show-closxp, comment="", echo=F}
filter_and_format_triples(data, "CLOSXP") %>%
  rename(formals=car_type, body=cdr_type, env=tag_type) %>%
  pretty_print_data
```

# Character vectors

```{r show-charsxp, comment="", echo=F}
filter_and_format_vectors(data, "CHARSXP") %>%
  pretty_print_data
```

# Numeric vectors

```{r show-realsxp, comment="", echo=F}
filter_and_format_vectors(data, "REALSXP") %>%
  pretty_print_data
```

# Byte-code

```{r show-bcodesxp, comment="", echo=F}
filter_and_format_triples(data, "BCODESXP") %>%
  rename(code=car_type, consts=cdr_type, expr=tag_type) %>%
  pretty_print_data
```

# Symbols

```{r show-symsxp, comment="", echo=F}
filter_and_format_triples(data, "SYMSXP") %>%
  rename(pname=car_type, value=cdr_type, internal=tag_type) %>%
  pretty_print_data
```

# External pointers

```{r show-extptrsxp, comment="", echo=F}
filter_and_format_triples(data, "EXTPTRSXP") %>%
  rename(ptr=car_type, tag=tag_type, prot=cdr_type) %>%
  pretty_print_data
```

# Weak references

```{r show-weakrefsxp, comment="", echo=F}
filter_and_format_triples(data, "WEAKREFSXP") %>%
  rename(key=car_type, value=tag_type, finalizer=cdr_type) %>%
  pretty_print_data
```

# Built-ins 

```{r show-builtinsxp, comment="", echo=F}
filter_and_format_triples(data, "BUILTINSXP") %>%
  rename(offset=car_type) %>%
  select(offset, count, percent) %>%
  pretty_print_data
```

# Expression vector

```{r show-exprsxp, comment="", echo=F}
filter_and_format_vectors(data, "EXPRSXP") %>%
  pretty_print_data
```

# Complex vector

```{r show-cplxsxp, comment="", echo=F}
filter_and_format_vectors(data, "CPLXSXP") %>%
  pretty_print_data
```

# Specials

```{r show-specialsxp, comment="", echo=F}
filter_and_format_triples(data, "SPECIALSXP") %>%
  rename(offset=car_type) %>%
  select(offset, count, percent) %>%
  pretty_print_data
```

# S4 objects